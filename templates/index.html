<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
        rel="stylesheet"
        as="style"
        onload="this.rel='stylesheet'"
        href="https://fonts.googleapis.com/css2?display=swap&family=Manrope%3Awght%40400%3B500%3B700%3B800&family=Noto+Sans%3Awght%40400%3B500%3B700%3B900"
    />
    <title>ACTMO</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

<style>
.ai-markdown {
    font-size: 1.08em;
    color: #e0ffe3;
    line-height: 1.7;
    -webkit-font-smoothing: antialiased;
}
.ai-markdown ul, .ai-markdown ol { margin: 1em 0 1em 1.5em; padding-left: 1.2em; }
.ai-markdown ul { list-style-type: disc; }
.ai-markdown ol { list-style-type: decimal; }
.ai-markdown li { margin-bottom: 0.5em; }
.ai-markdown strong, .ai-markdown b { font-weight: bold; color: #a2ffb8; }
.ai-markdown em, .ai-markdown i { color: #a2c398; font-style: italic; }
.ai-markdown h1, .ai-markdown h2, .ai-markdown h3 { color: #53d22c; margin: 1.2em 0 0.5em 0; font-weight: bold; line-height: 1.2; }
.ai-markdown p { margin-bottom: 1em; }
.ai-markdown code { background: #1b2a17; color: #baffc9; padding: 0.15em 0.35em; border-radius: 4px; font-size: 0.98em; }
.ai-markdown blockquote { border-left: 4px solid #53d22c; background: #1b2a17; color: #a2c398; margin: 1em 0; padding: 0.7em 1em; border-radius: 0.4em; font-style: italic; }
/* Initial state for the chart container - no fixed height */
#stockChartContainer {
    width: 100%;
    height: 400px !important; /* Or a smaller placeholder height */
}
.chart-loading {
    height: 400px; /* Or a smaller placeholder height */
    display: block;
    align-items: center;
    justify-content: center;
    color: #a2c398;
    font-size: 0.9em;
}
</style>
</head>
<body>
    <div class="relative flex size-full min-h-screen flex-col bg-[#162013] dark group/design-root overflow-x-hidden" style="font-family: Manrope, 'Noto Sans', sans-serif;">
        <div class="layout-container flex h-full grow flex-col">
            <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#2e4328] px-10 py-3">
                <div class="flex items-center gap-4 text-white">
                    <div class="size-4">
                        <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M44 4H30.6666V17.3334H17.3334V30.6666H4V44H44V4Z" fill="currentColor"></path></svg>
                    </div>
                    <h2 class="text-white text-lg font-bold leading-tight tracking-[-0.015em]">ACTMO</h2>
                </div>
                <div class="flex flex-1 justify-end gap-8">
                    <div class="flex items-center gap-9">
                        <a class="text-sm font-medium leading-normal text-bold text-green-200" href="{{ url_for('index') }}">AI Analysis</a> <a class="text-white text-sm font-medium leading-normal">Info</a> <a class="text-white text-sm font-medium leading-normal" href="#">Education</a>
                        <a class="text-white text-sm font-medium leading-normal" href="#">Community</a>
                    </div>
                    <button class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 bg-[#2e4328] text-white gap-2 text-sm font-bold leading-normal tracking-[0.015em] min-w-0 px-2.5">
                        <div class="text-white" data-icon="Bell" data-size="20px" data-weight="regular">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor" viewBox="0 0 256 256">
                                <path d="M221.8,175.94C216.25,166.38,208,139.33,208,104a80,80,0,1,0-160,0c0,35.34-8.26,62.38-13.81,71.94A16,16,0,0,0,48,200H88.81a40,40,0,0,0,78.38,0H208a16,16,0,0,0,13.8-24.06ZM128,216a24,24,0,0,1-22.62-16h45.24A24,24,0,0,1,128,216ZM48,184c7.7-13.24,16-43.92,16-80a64,64,0,1,1,128,0c0,36.05,8.28,66.73,16,80Z"></path>
                            </svg>
                        </div>
                    </button>
                    <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuAZVn3bMhYulfeZIVElbB0xb6S2Ss44PoyJKsbuwPwt0oL34gxugmwCQ6fDEPdL511L_ySaha5jXdYUmT4cy078iTnhgl_sFU47pskwBJNm1H4i72K6JQLkbhzJl-ypUsxtZGAtGrUVAaRqChOC2s8I8INpaglbEXKq_itBo0_aXhPJpruxL2qiNouIX5pZTyXY7t8pKKLKeswCoOmZci6OyP0qNt0qdenFJJYAH1W8eavFOlYA7GuxY9cUy9LuEATYBuVqS2QC-g4");'></div>
                </div>
            </header>

            <a href="{{ url_for('info') }}">Go to Info</a>

            <div class="px-4 md:px-40 flex flex-1 justify-center py-5">
                <div class="layout-content-container flex flex-col w-full max-w-[960px] py-5 flex-1"> <h2 class="text-white tracking-light text-[28px] font-bold leading-tight px-4 text-left pb-3 pt-5">Options Trade Analyzer</h2>
                    <p class="text-[#a2c398] text-sm font-normal leading-normal pb-3 pt-1 px-4">
                        Disclaimer: This tool provides AI-driven analysis for options trading and should not be considered financial advice. Always consult with a qualified financial advisor
                        before making investment decisions.
                    </p>

                    {% if error %}
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 mx-4" role="alert">
                        <span class="block sm:inline">{{ error }}</span>
                    </div>
                    {% endif %}

                    <form method="POST" action="{{ url_for('index') }}" class="space-y-0"> <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
                            <label class="flex flex-col min-w-40 flex-1">
                                <p class="text-white text-base font-medium leading-normal pb-2">Stock Symbol</p>
                                <input
                                    name="symbol"
                                    id="stockSymbolInput" placeholder="e.g., AAPL"
                                    class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border border-[#426039] bg-[#21301c] focus:border-[#426039] h-14 placeholder:text-[#a2c398] p-[15px] text-base font-normal leading-normal"
                                    value="{{ request_form.symbol or '' }}" required
                                />
                            </label>
                        </div>

                        <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
                            <label class="flex flex-col min-w-40 flex-1">
                                <p class="text-white text-base font-medium leading-normal pb-2">Strike Price</p>
                                <input
                                    name="strike"
                                    type="number"
                                    step="0.01"
                                    placeholder="e.g., 150"
                                    class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border border-[#426039] bg-[#21301c] focus:border-[#426039] h-14 placeholder:text-[#a2c398] p-[15px] text-base font-normal leading-normal"
                                    value="{{ request_form.strike or '' }}" required
                                />
                            </label>
                        </div>
                        <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
                            <label class="flex flex-col min-w-40 flex-1">
                                <p class="text-white text-base font-medium leading-normal pb-2">Premium</p>
                                <input
                                    name="premium"
                                    type="number"
                                    step="0.01"
                                    placeholder="e.g., 5.00"
                                    class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border border-[#426039] bg-[#21301c] focus:border-[#426039] h-14 placeholder:text-[#a2c398] p-[15px] text-base font-normal leading-normal"
                                    value="{{ request_form.premium or '' }}" required
                                />
                            </label>
                        </div>
                        <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
                            <label class="flex flex-col min-w-40 flex-1">
                                <p class="text-white text-base font-medium leading-normal pb-2">Days to Expiration (DTE)</p>
                                <input
                                    name="dte"
                                    type="number"
                                    placeholder="e.g., 30"
                                    class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border border-[#426039] bg-[#21301c] focus:border-[#426039] h-14 placeholder:text-[#a2c398] p-[15px] text-base font-normal leading-normal"
                                    value="{{ request_form.dte or '' }}" required
                                />
                            </label>
                        </div>
                        <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
                            <label class="flex flex-col min-w-40 flex-1">
                                <p class="text-white text-base font-medium leading-normal pb-2">Call/Put</p>
                                <select
                                    name="type"
                                    class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border border-[#426039] bg-[#21301c] focus:border-[#426039] h-14 bg-[image:--select-button-svg] placeholder:text-[#a2c398] p-[15px] text-base font-normal leading-normal"
                                    required
                                >
                                    <option value="call" {% if request_form.type == "call" %}selected{% endif %}>Call</option>
                                    <option value="put" {% if request_form.type == "put" %}selected{% endif %}>Put</option>
                                </select>
                            </label>
                        </div>
                        <div class="flex px-4 py-3 justify-end">
                            <button
                                type="submit"
                                class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-[#53d22c] text-[#162013] text-sm font-bold leading-normal tracking-[0.015em]"
                            >
                                <span class="truncate">Evaluate Trade</span>
                            </button>
                        </div>
                    </form>

                    <div id="currentPriceDisplay" class="px-4 mb-3"></div>

                    <div id="stockChartContainer" class="mb-6 mx-4"></div>

                    {% if analysis %}
                    <h2 class="text-white text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Technical Analysis Summary</h2>
                    <div class="p-4 grid grid-cols-[auto_1fr] gap-x-6 gap-y-1"> {% for item in analysis %}
                            {% set parts = item.split(":", 1) %}
                            {% set label = parts[0].strip() %}
                            {% set value = parts[1].strip() if parts|length > 1 else "" %}
                            <div class="col-span-2 grid grid-cols-subgrid border-t border-t-[#426039] py-3 items-center">
                                <p class="text-[#a2c398] text-sm font-normal leading-normal">{{ label }}</p>
                                <p class="text-white text-sm font-normal leading-normal text-right">{{ value }}</p> </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    
                    {% if ai_recommendation_html %}
                    <h2 class="text-white text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">AI Recommendation</h2>
                    <div class="bg-[#21301c] rounded-xl p-4 mx-4 mb-6">
                        <div class="ai-markdown text-white text-base font-normal leading-normal" style="font-size: 1.08em;">
                            {{ ai_recommendation_html | safe }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const symbolInput = document.getElementById('stockSymbolInput');
        const chartContainer = document.getElementById('stockChartContainer');
        const priceDisplayContainer = document.getElementById('currentPriceDisplay');
        let tradingViewWidget = null;
        const desiredChartHeight = '400px'; // Define the desired height once loaded

        async function fetchCurrentPrice(symbol) {
            try {
                const response = await fetch(`/get_current_price/${symbol}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Price not found');
                }
                const data = await response.json();
                return data.currentPrice;
            } catch (error) {
                console.error("Error fetching current price:", error);
                priceDisplayContainer.innerHTML = `<p class="text-red-400 text-sm font-semibold">⚠️ ${error.message}</p>`;
                return null;
            }
        }

        async function updateChartAndPrice(symbol) {
            // Clear previous chart and set chart container to a minimal loading state
            chartContainer.innerHTML = '<div class="chart-loading">Loading chart...</div>';
            chartContainer.style.height = '100px'; // Small height during loading
            priceDisplayContainer.innerHTML = '<p class="text-[#a2c398] text-sm">Fetching price...</p>';

            if (symbol && symbol.trim() !== "") {
                const upperSymbol = symbol.trim().toUpperCase();

                // Fetch and display current price
                const price = await fetchCurrentPrice(upperSymbol);
                if (price !== null) {
                    priceDisplayContainer.innerHTML = `<p class="text-white text-lg font-bold">Current Price for ${upperSymbol}: $${price.toFixed(2)}</p>`;
                } else {
                    if (!priceDisplayContainer.querySelector('.text-red-400')) {
                         priceDisplayContainer.innerHTML = `<p class="text-red-400 text-sm font-semibold">⚠️ Could not fetch current price for ${upperSymbol}.</p>`;
                    }
                }

                if (typeof TradingView === 'undefined' || !TradingView.widget) {
                    chartContainer.innerHTML = "<p class='text-red-400 text-sm px-4'>Error: Charting library failed to load. Chart cannot be displayed.</p>";
                    chartContainer.style.height = 'auto'; // Adjust height if library fails
                    if (!priceDisplayContainer.querySelector('.text-red-400') && price === null) {
                        priceDisplayContainer.innerHTML = `<p class="text-red-400 text-sm font-semibold">⚠️ Failed to load chart and price for ${upperSymbol}.</p>`;
                    }
                    return;
                }

                // Set the desired height before initializing the widget
                chartContainer.style.height = desiredChartHeight;
                chartContainer.innerHTML = ''; // Clear loading message before adding widget

                tradingViewWidget = new TradingView.widget({
                    "width": "100%",
                    "height": "100%", // Widget will use container's height
                    "symbol": upperSymbol,
                    "interval": "D",
                    "timezone": "America/New_York",
                    "theme": "dark",
                    "style": "1",
                    "locale": "en",
                    "enable_publishing": false,
                    "hide_side_toolbar": false,
                    "allow_symbol_change": true,
                    "container_id": "stockChartContainer",
                    "autosize": true, // Let widget adapt to container size
                    "studies": [
                        "STD;Volume",
                        "STD;MA%Cross"
                    ],
                    "callbacks": { // Use callbacks to know when chart is ready
                        onChartReady: function() {
                            console.log("TradingView Chart is ready!");
                            // Height is already set, but you could do other things here
                        },
                        onError: function(error) {
                            console.error("TradingView Widget Error:", error);
                            chartContainer.innerHTML = "<p class='text-red-400 text-sm px-4'>Error loading chart. Please try a different symbol or refresh.</p>";
                            chartContainer.style.height = 'auto'; // Reset height on error
                        }
                    }
                });
            } else {
                chartContainer.innerHTML = "";
                chartContainer.style.height = '0px'; // Collapse if no symbol
                priceDisplayContainer.innerHTML = "";
            }
        }

        if (symbolInput) {
            // Set initial state for chart container
            chartContainer.style.height = '0px';

            symbolInput.addEventListener('blur', function() {
                if (this.value.trim() !== "") {
                    updateChartAndPrice(this.value);
                } else {
                    chartContainer.innerHTML = "";
                    chartContainer.style.height = '0px';
                    priceDisplayContainer.innerHTML = "";
                }
            });

            symbolInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    if (this.value.trim() !== "") {
                         updateChartAndPrice(this.value);
                    } else {
                        chartContainer.innerHTML = "";
                        chartContainer.style.height = '0px';
                        priceDisplayContainer.innerHTML = "";
                    }
                }
            });

            // Load chart if symbol is already present on page load
            if (symbolInput.value && symbolInput.value.trim() !== '') {
                updateChartAndPrice(symbolInput.value);
            }
        }
    });
    </script>
</body>
</html>
